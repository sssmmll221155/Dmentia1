// Cognitive Tracking System - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User accounts
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  deviceId     String?  // Desktop app device ID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

// Raw batch metrics (every 10 seconds of activity)
model MetricsBatch {
  id        String   @id @default(uuid())
  userId    String
  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime @default(now())

  // Page context
  url    String
  domain String

  // Keyboard metrics
  keyboardKeyPressCount            Int
  keyboardBackspaceCount           Int
  keyboardEnterCount               Int
  keyboardMeanInterKeyIntervalMs   Float
  keyboardStdInterKeyIntervalMs    Float
  keyboardHoldTimes                String // JSON array of hold times (H)
  keyboardDownDownIntervals        String // JSON array of DD intervals
  keyboardUpDownIntervals          String // JSON array of UD intervals

  // Mouse metrics
  mouseMoveEventCount Int
  mouseMeanSpeedPxPerSec Float
  mouseStdSpeedPxPerSec  Float
  mouseTotalDistancePx   Float
  mouseClickCount        Int
  mouseDblclickCount     Int

  // Scroll metrics
  scrollEventCount      Int
  scrollMeanScrollSpeed Float
  scrollUpScrollFraction Float

  // Gaze metrics (nullable if eye tracking disabled)
  gazeEventCount           Int?
  gazeMeanFixationDurationMs Float?
  gazeSaccadeCount         Int?
  gazeMeanSaccadeLengthPx  Float?

  // Relations
  gazeEvents       GazeEvent[]
  fixationEvents   FixationEvent[]
  saccadeEvents    SaccadeEvent[]
  readingPatterns  ReadingPattern[]
  rereadingEvents  RereadingEvent[]
  regionFocuses    RegionFocus[]

  @@index([userId, startedAt])
  @@index([domain])
}

// Detailed gaze events (sampled subset)
model GazeEvent {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  timestamp      BigInt        // Unix timestamp in ms
  x              Float
  y              Float

  @@index([batchId])
}

// Fixation events - when gaze remains on a region
model FixationEvent {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  timestamp      BigInt        // Unix timestamp when fixation started
  x              Float         // Fixation center X coordinate
  y              Float         // Fixation center Y coordinate
  durationMs     Float         // How long the fixation lasted
  regionId       String?       // Optional screen region identifier

  @@index([batchId])
}

// Saccade events - rapid eye movements between fixations
model SaccadeEvent {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  timestamp      BigInt        // Unix timestamp when saccade started
  fromX          Float         // Starting X coordinate
  fromY          Float         // Starting Y coordinate
  toX            Float         // Ending X coordinate
  toY            Float         // Ending Y coordinate
  velocityPxPerSec Float       // Saccade velocity
  amplitudePx    Float         // Euclidean distance traveled
  durationMs     Float         // Saccade duration

  @@index([batchId])
}

// Reading pattern metrics for text-heavy interactions
model ReadingPattern {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  timestamp      BigInt        // Unix timestamp when pattern detected
  direction      String        // 'left-to-right', 'right-to-left', 'top-to-bottom', 'irregular'
  speedWordsPerMin Float?      // Estimated reading speed
  lineCount      Int           // Number of lines traversed
  regressionCount Int          // Number of backward saccades (re-reading)

  @@index([batchId])
}

// Re-reading events - when user revisits same screen region
model RereadingEvent {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  regionId       String        // Screen region identifier (e.g., "top-left-quadrant")
  visitCount     Int           // Number of times this region was revisited
  timestamps     String        // JSON array of visit timestamps
  totalDurationMs Float        // Total time spent in this region across all visits

  @@index([batchId])
  @@index([regionId])
}

// Focus duration per screen region
model RegionFocus {
  id             String        @id @default(uuid())
  batchId        String
  batch          MetricsBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  regionId       String        // Screen region identifier
  regionLabel    String?       // Human-readable label (e.g., "navigation", "content", "sidebar")
  x              Float         // Region center X
  y              Float         // Region center Y
  width          Float         // Region width
  height         Float         // Region height
  focusDurationMs Float        // Total focus time in this region
  fixationCount  Int           // Number of fixations in this region
  firstVisitTimestamp BigInt   // When region was first viewed
  lastVisitTimestamp  BigInt   // When region was last viewed

  @@index([batchId])
  @@index([regionId])
}

// Daily summary per user
model DailySummary {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  createdAt DateTime @default(now())

  // Activity metrics
  totalActiveSeconds Float
  totalBatches       Int

  // Keyboard aggregates
  avgKeyboardKeyPressRate          Float // keys per second
  avgKeyboardErrorRate             Float // backspace / total keys
  avgKeyboardInterKeyIntervalMs    Float
  keyboardInterKeyVariabilityMs    Float // std dev
  avgKeyboardHoldTimeMs            Float
  stdKeyboardHoldTimeMs            Float

  // Mouse aggregates
  avgMouseSpeedPxPerSec    Float
  stdMouseSpeedPxPerSec    Float
  avgMouseDistancePerBatch Float

  // Scroll aggregates
  avgScrollSpeed         Float
  scrollUpScrollFraction Float

  // Gaze aggregates (nullable)
  avgGazeFixationDurationMs Float?
  avgGazeSaccadeCount       Float?
  avgGazeSaccadeLengthPx    Float?

  @@unique([userId, date])
  @@index([userId, date])
}

// User baseline (computed from first N weeks of data)
model UserBaseline {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Baseline period
  baselineStartDate DateTime
  baselineEndDate   DateTime
  dayCount          Int

  // Keyboard baselines
  baselineKeyPressRate         Float
  baselineErrorRate            Float
  baselineInterKeyIntervalMs   Float
  baselineInterKeyVariabilityMs Float
  baselineHoldTimeMs           Float

  // Mouse baselines
  baselineMouseSpeed    Float
  baselineMouseSpeedStd Float

  // Gaze baselines (nullable)
  baselineFixationDurationMs Float?
  baselineSaccadeCount       Float?

  @@index([userId])
}

// Deviation alerts (when metrics drift from baseline)
model DeviationAlert {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  createdAt DateTime @default(now())

  // Alert metadata
  severity  String // 'low', 'medium', 'high'
  status    String @default("new") // 'new', 'acknowledged', 'resolved'

  // Which metrics deviated
  deviatedMetrics String // JSON string: { "keyboardErrorRate": { "baseline": 0.05, "current": 0.15, "stdDevs": 3.2 }, ... }

  // Multi-modal correlation score (0-1)
  // Higher = more metrics showing consistent deviation
  correlationScore Float

  // Human-readable summary
  summary String

  @@unique([userId, date])
  @@index([userId, date])
  @@index([status])
}
